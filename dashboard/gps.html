<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MF-25 - GPS & Lap Timer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg-color:#1a1a1a;
      --panel-color:#2c2c2c;
      --text-color:#e0e0e0;
      --accent-yellow:#ffc300;
      --accent-red:#e63946;
      --panel-border:#333;
      --panel-shadow: rgba(0,0,0,0.5);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Roboto',sans-serif;
      background:var(--bg-color);
      color:var(--text-color);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:10px;
    }
    .container{
      width:100%;
      max-width:1000px;
      background:#000;
      border:2px solid var(--panel-border);
      border-radius:10px;
      padding:10px;
      box-shadow:0 0 20px var(--panel-shadow);
    }
    nav{
      display:flex;
      flex-wrap:wrap;
      border-bottom:2px solid var(--panel-border);
      margin-bottom:15px;
    }
    nav a{
      flex:1; min-width:120px; text-align:center; padding:10px;
      color:var(--text-color); text-decoration:none;
      font-family:'Orbitron',sans-serif; font-weight:500;
      border-bottom:3px solid transparent; transition:all .3s ease;
    }
    nav a.active{ color:var(--accent-yellow); border-bottom-color:var(--accent-yellow); }

    .map-section{
      background:var(--panel-color);
      border-radius:8px;
      border:1px solid var(--panel-border);
      padding:10px;
    }
    .speed-bar{
      display:flex; justify-content:center; gap:10px; align-items:baseline;
      background:#0b0b0b; border:1px solid var(--panel-border);
      border-radius:10px; padding:8px 14px; margin-bottom:10px;
    }
    .speed-value{
      font-family:'Orbitron',sans-serif; font-weight:900; letter-spacing:1px;
      font-size:42px; line-height:1; color:var(--accent-yellow);
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
    }
    .speed-unit{ font-family:'Orbitron',sans-serif; color:#cfd8ff; opacity:0.9; font-size:16px; }

    .map-wrap{
      border-radius:10px; border:1px solid var(--panel-border);
      overflow:hidden; background:#0b0b0b; box-shadow: inset 0 0 8px rgba(255,195,0,0.08);
    }
    #map{ width:100%; height:520px; }

    .info-bar{
      display:flex; gap:10px; align-items:stretch;
      padding:10px; background:#0c0c0c; border:1px solid var(--panel-border);
      border-radius:8px; margin-top:12px; flex-wrap:wrap;
    }
    .info-card{
      flex:1; min-width:180px; background:#111; border:1px solid var(--panel-border);
      border-radius:8px; padding:10px 12px; display:flex; flex-direction:column; gap:6px;
    }
    .info-label{ font-size:12px; color:#bbb; }
    .info-value{ font-family:'Orbitron',sans-serif; font-size:18px; color:var(--accent-yellow); font-weight:700; }

    .actions{ display:flex; gap:10px; align-items:center; margin-left:auto; }
    .btn{
      background:var(--accent-yellow); color:#111; border:1px solid #8c6d00;
      border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:900;
      transition: all .15s ease;
      font-family: 'Roboto', sans-serif;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:active{ transform:translateY(1px); filter:brightness(1.0); }
    .btn-secondary {
        background: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
    }

    /* ===== LAP TIMER STYLES ===== */
    .laptimer-section {
        margin-top: 14px;
        background: var(--panel-color);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    .timer-display-wrap {
        text-align: center;
        padding: 12px 10px;
        border-bottom: 1px solid var(--panel-border);
    }
    .lap-count {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        color: #bbb;
        margin-bottom: 4px;
        letter-spacing: 1px;
    }
    .timer-display {
        font-family: 'Orbitron', sans-serif;
        font-size: 48px;
        font-weight: 700;
        color: var(--text-color);
        letter-spacing: 1.5px;
    }
    .laps-list-wrap {
        flex-grow: 1;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px 10px;
    }
    #lapList {
        list-style: none;
        padding: 0;
        margin: 0;
        font-family: 'Roboto', sans-serif;
    }
    #lapList li {
        display: flex;
        justify-content: space-between;
        padding: 9px 4px;
        border-bottom: 1px solid #222;
        font-size: 16px;
    }
    #lapList li:first-child {
        font-weight: 700;
        color: var(--accent-yellow);
    }
    #lapList .lap-num {
        color: #bbb;
        margin-right: 20px;
    }
    #lapList .lap-time {
        font-family: 'Orbitron', sans-serif;
    }
    .laps-list-wrap::-webkit-scrollbar { width: 6px; }
    .laps-list-wrap::-webkit-scrollbar-track { background: #1a1a1a; }
    .laps-list-wrap::-webkit-scrollbar-thumb { background-color: #555; border-radius: 6px; }


    .three-section{
      margin-top:14px; background:var(--panel-color);
      border:1px solid var(--panel-border); border-radius:8px; padding:10px;
    }
    .three-wrap{
      position:relative; border-radius:10px; border:1px solid var(--panel-border);
      overflow:hidden; background:#0a0a0a; height:380px;
    }
    canvas.three-canvas{ width:100%; height:100%; display:block; }

    .accel-hud{
      position:absolute; right:12px; top:12px;
      background:rgba(0,0,0,0.45); border:1px solid #222; border-radius:10px;
      padding:10px 12px; color:#eaeaea; font-size:13px; backdrop-filter: blur(3px); z-index: 5;
    }
    .accel-hud .title{ font-family:'Orbitron',sans-serif; color:#ffd866; font-size:12px; margin-bottom:6px; }
    .accel-row{ display:flex; justify-content:space-between; gap:14px; }
    .accel-row + .accel-row{ margin-top:4px; }
    .badge{ color:#9bd3ff; }

    @media (max-width:768px){
      #map{ height:420px; }
      .speed-value{ font-size:34px; }
      .timer-display { font-size: 38px; }
      .three-wrap{ height:320px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <a href="./dashboard.html">Main Dashboard</a>
      <a href="./sensor.html">Sensor data</a>
      <a href="./gps.html" class="active">GPS</a>
    </nav>

    <section class="map-section">
      <div class="speed-bar" aria-live="polite">
        <div id="speedVal" class="speed-value">--.-</div>
        <div class="speed-unit">km/h</div>
      </div>
      <div class="map-wrap">
        <div id="map"></div>
      </div>
      <div class="info-bar">
        <div class="info-card">
          <div class="info-label">고도</div>
          <div id="altVal" class="info-value">-- m</div>
        </div>
        <div class="info-card">
          <div class="info-label">방향</div>
          <div id="headVal" class="info-value">--°</div>
        </div>
        <div class="actions">
          <button id="btnReset" class="btn" title="기록된 이동경로를 지웁니다">이동경로 초기화</button>
        </div>
      </div>
    </section>

    <section class="laptimer-section">
        <div class="timer-display-wrap">
            <div id="lapCount" class="lap-count">LAP 1</div>
            <div id="timerDisplay" class="timer-display">00:00.000</div>
        </div>
        <div class="laps-list-wrap">
            <ul id="lapList">
            </ul>
        </div>
        <div class="info-bar" style="margin-top:0; padding-top:10px; border-top: 1px solid var(--panel-border);">
            <div class="actions" style="width:100%; justify-content:flex-end;">
                <button id="btnLapReset" class="btn btn-secondary" title="랩타임 기록을 초기화합니다">초기화</button>
                <button id="btnLapAction" class="btn" title="랩타임 측정을 시작하거나 랩을 기록합니다">시작</button>
            </div>
        </div>
    </section>

    <section class="three-section">
      <div class="three-wrap">
        <div class="accel-hud">
          <div class="title">ADXL345</div>
          <div class="accel-row"><span class="badge">Ax</span><span id="axVal">--</span> <span>g</span></div>
          <div class="accel-row"><span class="badge">Ay</span><span id="ayVal">--</span> <span>g</span></div>
          <div class="accel-row"><span class="badge">Az</span><span id="azVal">--</span> <span>g</span></div>
          <div class="accel-row" style="margin-top:6px;"><span class="badge">Pitch</span><span id="pitchVal">--</span> <span>°</span></div>
          <div class="accel-row"><span class="badge">Roll</span><span id="rollVal">--</span> <span>°</span></div>
        </div>

        <canvas id="threeCanvas" class="three-canvas"></canvas>
        
        <div class="actions" style="position:absolute; bottom:12px; right:12px; z-index: 5;">
            <button id="btnCalibrate" class="btn btn-secondary" title="현재 차량의 기울기를 기본 자세로 설정합니다.">자세 보정 (영점 설정)</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* global L, firebase */
    (function(){
      const links = document.querySelectorAll('nav a');
      const current = window.location.pathname.split('/').pop() || 'gps.html';
      links.forEach(a => { if (a.getAttribute('href').includes(current)) a.classList.add('active'); });
    })();

    // ===== Firebase: config.py와 동일하게 =====
    const firebaseConfig = {
      apiKey: "AIzaSyA44pnRn5t073UuSOPw3mkVwjvCLP4ZzJU",
      authDomain: "emucanlogger.firebaseapp.com",
      databaseURL: "https://emucanlogger-default-rtdb.firebaseio.com",
      projectId: "emucanlogger",
      storageBucket: "emucanlogger.firebasestorage.app",
      messagingSenderId: "289716936070",
      appId: "1:289716936070:web:8502e0f2c69ae362616007"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== 데이터 소스 경로 =====
    const REALTIME_PATH = "emu_realtime_data";
    const GPS_LOGS_PATH = "gps_logs";

    // ===== 지도 준비 =====
    const map = L.map('map', { zoomControl: true }).setView([37.5665,126.9780], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

    let marker = null;
    let trackLine = L.polyline([], { color:'#ffc300', weight:4, opacity:0.9 }).addTo(map);

    // ===== 유틸 =====
    const toNum = v => {
      const n = Number(v);
      return Number.isFinite(n) ? n : undefined;
    };

    const TRACK_KEY = 'mf25_gps_track';
    function saveTrack(){
      const latlngs = trackLine.getLatLngs().map(p => [p.lat, p.lng]);
      localStorage.setItem(TRACK_KEY, JSON.stringify(latlngs));
    }
    (function restoreTrack(){
      try{
        const raw = localStorage.getItem(TRACK_KEY);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          trackLine.setLatLngs(arr);
          map.fitBounds(trackLine.getBounds(), {padding:[20,20]});
        }
      }catch(e){}
    })();

    const speedEl = document.getElementById('speedVal');
    const altEl   = document.getElementById('altVal');
    const headEl  = document.getElementById('headVal');
    const btnReset = document.getElementById('btnReset');

    function render({lat, lon, spd, alt, hdg}) {
      if (lat !== undefined && lon !== undefined) {
        const ll = [lat, lon];
        if (!marker) {
          marker = L.marker(ll).addTo(map);
          map.setView(ll, 17, { animate:false });
        } else {
          marker.setLatLng(ll);
        }
        const last = trackLine.getLatLngs().slice(-1)[0];
        if (!last || last.lat !== lat || last.lng !== lon) {
          trackLine.addLatLng(ll);
          saveTrack();
        }
      }
      speedEl.textContent = spd !== undefined ? spd.toFixed(1) : "--.-";
      altEl.textContent   = alt !== undefined ? `${alt.toFixed(1)} m` : "-- m";
      headEl.textContent  = hdg !== undefined ? `${hdg.toFixed(0)}°`   : "--°";
    }

    // ===== 데이터 구독 =====
    const refRealtime = db.ref(REALTIME_PATH);
    const refGpsLogs  = db.ref(GPS_LOGS_PATH);
    let hadRealtimeFix = false;

    refRealtime.on("value", snap => {
      const d = snap.val();
      if (!d) return;
      const lat = toNum(d.lat ?? d.latitude);
      const lon = toNum(d.lon ?? d.lng ?? d.longitude);
      const spd = toNum(d.GPS_Speed_KPH ?? d.gps_speed ?? d.speed_kph ?? d.VSS_kmh);
      const alt = toNum(d.altitude ?? d.alt ?? d.gps_alt);
      const hdg = toNum(d.heading ?? d.course ?? d.bearing);
      if (lat !== undefined && lon !== undefined) hadRealtimeFix = true;
      render({lat, lon, spd, alt, hdg});
    });

    refGpsLogs.orderByKey().limitToLast(1).on('value', snap => {
      if (hadRealtimeFix || !snap.exists()) return;
      let v; snap.forEach(ch => v = ch.val());
      if (!v) return;
      const lat = toNum(v.latitude);
      const lon = toNum(v.longitude);
      const spd = toNum(v.speed_kph);
      render({lat, lon, spd});
    });

    btnReset.addEventListener('click', () => {
      trackLine.setLatLngs([]);
      localStorage.removeItem(TRACK_KEY);
    });

    // ===== LAP TIMER LOGIC =====
    const timerDisplay = document.getElementById('timerDisplay');
    const lapCountDisplay = document.getElementById('lapCount');
    const lapList = document.getElementById('lapList');
    const actionBtn = document.getElementById('btnLapAction');
    const resetBtn = document.getElementById('btnLapReset');

    let timerState = {
        isRunning: false,
        lapStartTime: 0,
        requestID: null,
        laps: []
    };

    function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const milliseconds = Math.floor((ms % 1000));
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
    }

    function renderLaps() {
        lapList.innerHTML = '';
        [...timerState.laps].reverse().forEach(lap => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="lap-num">Lap ${lap.lap}</span><span class="lap-time">${formatTime(lap.time)}</span>`;
            lapList.appendChild(li);
        });
    }

    function updateTimer() {
        const now = performance.now();
        const lapTime = now - timerState.lapStartTime;
        timerDisplay.textContent = formatTime(lapTime);
        timerState.requestID = requestAnimationFrame(updateTimer);
    }

    function startTimer() {
        timerState.isRunning = true;
        const now = performance.now();
        timerState.lapStartTime = now;
        timerState.laps = [];
        lapCountDisplay.textContent = `LAP 1`;
        actionBtn.textContent = 'Lap';
        actionBtn.style.background = 'var(--accent-red)';
        actionBtn.style.borderColor = '#a31f2b';
        timerState.requestID = requestAnimationFrame(updateTimer);
    }

    function recordLap() {
        const now = performance.now();
        const lapTime = now - timerState.lapStartTime;
        const currentLapNumber = timerState.laps.length + 1;
        timerState.laps.push({ lap: currentLapNumber, time: lapTime });
        timerState.lapStartTime = now;
        lapCountDisplay.textContent = `LAP ${currentLapNumber + 1}`;
        renderLaps();
    }

    function resetTimer() {
        if (timerState.requestID) {
            cancelAnimationFrame(timerState.requestID);
        }
        timerState.isRunning = false;
        timerState.laps = [];
        timerState.requestID = null;
        timerDisplay.textContent = '00:00.000';
        lapCountDisplay.textContent = 'LAP 1';
        actionBtn.textContent = '시작';
        actionBtn.style.background = '';
        actionBtn.style.borderColor = '';
        renderLaps();
    }

    actionBtn.addEventListener('click', () => {
        if (timerState.isRunning) {
            recordLap();
        } else {
            startTimer();
        }
    });

    resetBtn.addEventListener('click', resetTimer);

  </script>

  <script type="module">
    /* global firebase */
    import * as THREE from 'https://esm.sh/three@0.159.0';
    import { OrbitControls } from 'https://esm.sh/three@0.159.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://esm.sh/three@0.159.0/examples/jsm/loaders/GLTFLoader.js';

    // ====== 부드러운 보간을 위한 설정 ======
    const BUFFER_DELAY_MS = 180;
    const MAX_BUFFER_MS   = 2000;
    const EXTRAP_MAX_MS   = 120;
    const EMA_TAU_MS      = 120;
    const ROT_RESP_MS     = 120;

    // ----- 가속도 샘플 버퍼 -----
    class SampleBuffer {
      constructor() { this.arr = []; }
      push(sample) {
        this.arr.push(sample);
        const tNow = performance.now();
        while (this.arr.length && (tNow - this.arr[0].t) > MAX_BUFFER_MS) this.arr.shift();
      }
      getAt(t) {
        const a = this.arr;
        if (a.length === 0) return null;
        if (t <= a[0].t) {
          const dt = a[0].t - t;
          if (dt > EXTRAP_MAX_MS) return null;
          return { ax: a[0].ax, ay: a[0].ay, az: a[0].az };
        }
        if (t >= a[a.length-1].t) {
          const dt = t - a[a.length-1].t;
          if (dt > EXTRAP_MAX_MS) return null;
          return { ax: a[a.length-1].ax, ay: a[a.length-1].ay, az: a[a.length-1].az };
        }
        let lo = 0, hi = a.length - 1;
        while (lo + 1 < hi) {
          const mid = (lo + hi) >> 1;
          if (a[mid].t <= t) lo = mid; else hi = mid;
        }
        const s0 = a[lo], s1 = a[lo+1];
        const w = (t - s0.t) / (s1.t - s0.t);
        const lerp = (x,y)=> x + (y-x)*w;
        return { ax: lerp(s0.ax, s1.ax), ay: lerp(s0.ay, s1.ay), az: lerp(s0.az, s1.az) };
      }
    }
    const buf = new SampleBuffer();

    // ====== THREE 기본 셋업 ======
    const canvas = document.getElementById('threeCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
    camera.position.set(3.2, 2.0, 4.2);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.08;
    controls.enablePan = false; controls.minDistance = 2; controls.maxDistance = 12;

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); scene.add(dir);

    const ground = new THREE.Mesh(
      new THREE.CircleGeometry(20, 64),
      new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.95, metalness: 0.0 })
    );
    ground.rotateX(-Math.PI/2); ground.position.y = -0.01; scene.add(ground);

    let car = new THREE.Group();
    car.quaternion.identity();
    const loader = new GLTFLoader();
    loader.load('./car.glb', (gltf)=>{
      car = gltf.scene || new THREE.Group();
      const box0 = new THREE.Box3().setFromObject(car);
      const size0 = new THREE.Vector3(); box0.getSize(size0);
      const maxDim = Math.max(size0.x, size0.y, size0.z) || 1;
      const scale = 2.0 / maxDim;
      car.scale.setScalar(scale);
      const box1 = new THREE.Box3().setFromObject(car);
      const center = new THREE.Vector3(); box1.getCenter(center);
      car.position.sub(center);
      const box2 = new THREE.Box3().setFromObject(car);
      const raise = -box2.min.y + 0.02;
      car.position.y += (isFinite(raise) ? raise : 0.02);
      scene.add(car);
    }, undefined, ()=>{
      const mesh = new THREE.Mesh(new THREE.BoxGeometry(2,0.6,4), new THREE.MeshStandardMaterial({ color: 0x2266ff }));
      mesh.position.y = 0.3;
      car.add(mesh);
      scene.add(car);
    });

    let envGroup = new THREE.Group();
    scene.add(envGroup);
    function setCircuitEnv(){
      renderer.setClearColor(0x060606, 1);
      ground.visible = false;
      const plane = new THREE.Mesh(new THREE.PlaneGeometry(120, 120), new THREE.MeshStandardMaterial({ color: 0x151515 }));
      plane.rotation.x = -Math.PI/2; envGroup.add(plane);
      const grid = new THREE.GridHelper(120, 60, 0x333333, 0x242424);
      grid.position.y = 0.01; envGroup.add(grid);
    }
    setCircuitEnv();

    function resize(){
      const {width:w, height:h} = canvas.getBoundingClientRect();
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.setSize(w, h, false);
      camera.aspect = w/h; camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize);
    resize();

    // ====== 가속도 → 각도 계산 & 매끄럽게 표시 ======
    const axEl = document.getElementById('axVal'), ayEl = document.getElementById('ayVal'), azEl = document.getElementById('azVal');
    const pitchEl = document.getElementById('pitchVal'), rollEl  = document.getElementById('rollVal');
    
    const btnCalibrate = document.getElementById('btnCalibrate');
    let zeroQuaternionInverse = new THREE.Quaternion();

    let ema = { ax: 0, ay: 0, az: 1 };
    let emaInit = false;
    
    const qTarget = new THREE.Quaternion();
    const eulerTmp = new THREE.Euler(0, 0, 0, 'XYZ');

    const toG = (v) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return null;
      return Math.abs(n) > 3.2 ? (n / 9.80665) : n;
    };

    const accRef = window.firebase.database().ref("emu_realtime_data");
    accRef.on("value", snap => {
      const d = snap.val(); if(!d) return;
      const cands = [
        {x:'ax_g', y:'ay_g', z:'az_g'}, {x:'ax', y:'ay', z:'az'},
        {x:'AccelX', y:'AccelY', z:'AccelZ'}, {x:'acc_x', y:'acc_y', z:'acc_z'}
      ];
      let ax, ay, az;
      for (const k of cands){
        if (d[k.x]!==undefined && d[k.y]!==undefined && d[k.z]!==undefined){
          ax = toG(d[k.x]); ay = toG(d[k.y]); az = toG(d[k.z]); break;
        }
      }
      if (ax==null || ay==null || az==null) return;
      const tRemote = Number(d.ts ?? d.timestamp);
      const t = Number.isFinite(tRemote) ? tRemote : performance.now();
      buf.push({ t, ax, ay, az });
    });

    function accelToAngles(ax, ay, az){
      const m = Math.hypot(ax, ay, az) || 1;
      const x = ax / m, y = ay / m, z = az / m;
      const pitch = Math.atan2(x, Math.hypot(y, z));
      const roll  = Math.atan2(y, z);
      return { pitch, roll };
    }
    
    btnCalibrate.addEventListener('click', () => {
        const { pitch, roll } = accelToAngles(ema.ax, ema.ay, ema.az);
        eulerTmp.set(pitch, 0, -roll, 'XYZ');
        const currentOrientation = new THREE.Quaternion().setFromEuler(eulerTmp);
        zeroQuaternionInverse.copy(currentOrientation).invert();
        btnCalibrate.textContent = "영점 설정 완료!";
        setTimeout(() => {
            btnCalibrate.textContent = "자세 보정 (영점 설정)";
        }, 1500);
    });


    const clock = new THREE.Clock();

    function animate(){
      const dt = clock.getDelta() * 1000;
      const now = performance.now();
      const tDisplay = now - BUFFER_DELAY_MS;

      const s = buf.getAt(tDisplay);
      if (s){
        const alpha = 1 - Math.exp(-dt / EMA_TAU_MS);
        if (!emaInit){
          ema = { ax: s.ax, ay: s.ay, az: s.az };
          emaInit = true;
        } else {
          ema.ax += (s.ax - ema.ax) * alpha;
          ema.ay += (s.ay - ema.ay) * alpha;
          ema.az += (s.az - ema.az) * alpha;
        }

        axEl.textContent = ema.ax.toFixed(3);
        ayEl.textContent = ema.ay.toFixed(3);
        azEl.textContent = ema.az.toFixed(3);

        const { pitch, roll } = accelToAngles(ema.ax, ema.ay, ema.az);
        
        eulerTmp.set(pitch, 0, -roll, 'XYZ');
        const absoluteOrientation = new THREE.Quaternion().setFromEuler(eulerTmp);

        qTarget.multiplyQuaternions(absoluteOrientation, zeroQuaternionInverse);
        
        const slerpAlpha = 1 - Math.exp(-dt / ROT_RESP_MS);
        car.quaternion.slerp(qTarget, slerpAlpha);

        pitchEl.textContent = (pitch*180/Math.PI).toFixed(1);
        rollEl.textContent  = (roll *180/Math.PI).toFixed(1);
      }

      controls.update();
      renderer.render(scene, camera);
    }
    renderer.setAnimationLoop(animate);
  </script>
</body>
</html>
